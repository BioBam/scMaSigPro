---
title: "Development of ScMaSig Pro"
author: "Priyansh Srivastava"
date: "`r Sys.Date()`"
output: html_document
---

## Required library
```{r, message=FALSE}
load <- function() {
  suppressPackageStartupMessages(library(maSigPro))
  suppressPackageStartupMessages(library(MASS))
  suppressPackageStartupMessages(library(tidyverse))
  suppressPackageStartupMessages(library(DHARMa))
  suppressPackageStartupMessages(library(glmmTMB))
  suppressPackageStartupMessages(library(scran))
  suppressPackageStartupMessages(library(scMaSigPro))
  # suppressPackageStartupMessages(library(assertthat))
  # suppressPackageStartupMessages(library(doParallel))
  # suppressPackageStartupMessages(library(parallel))
  # suppressPackageStartupMessages(library(future))
}
```

## Load Data
```{r, message=FALSE}
load()
sce.test <- readRDS("../data/sce.test.RDS")
scmp.obj <- sc_makeDesign(sce.object = sce.test)
scmp.obj.zi <- sc_pVector(scmp.obj, p.vector.sig = 0.05, model.type = "zip")
```


# Running T-fit
```{r, eval=FALSE, message=F, echo=FALSE, warning=FALSE}
scmp.obj.zi.tfi <- sc_tFit(scmp.obj.zi)
```

# Selection of Siginificant Models
```{r, eval=FALSE, message=F, echo=FALSE, warning=FALSE}
scmp.obj <- sc.sel.features(scmp.obj,
                            filter = "rsq",
                            Q =  0.05
)
# SaveObject
saveRDS(scmp.obj, file = "../extdata/scmp_sigGenes_sc.sel.features().RDS")
scmp.obj
```

---

### Create Testable objects for testthat()
```{r, eval=FALSE, message=F, echo=FALSE, warning=FALSE}
# Load the library
suppressPackageStartupMessages(library(maSigPro))
suppressPackageStartupMessages(library(MASS))

# Load object from the /data
sce.test <- readRDS("../data/sce.test.RDS")

# Create a simple design file
design.file <- as.data.frame(colData(sce.test))
design.file$Path1 <- ifelse(design.file$Group == "Path1", 1, 0)
design.file$Path2 <- ifelse(design.file$Group == "Path2", 1, 0)
design.file$Rep <- c(1:nrow(design.file))
design.file <- design.file[, c(5, 8, 6, 7), ]

# Extract the counts
gCounts <- as.matrix(sce.test@assays@data$counts)
all(colnames(gCounts) == rownames(design.file$edesign))

# Create Design file
x <- capture.output(new.design.file <- make.design.matrix(
  edesign = design.file, degree = 2,
  time.col = 1, repl.col = 2
))

# Running Pvector and TFit
x <- capture.output(p.ob <- p.vector(
  data = as.matrix(gCounts), Q = 0.4,
  design = new.design.file,
  counts = T, family = negative.binomial(10)
))

# Save the object for testing later
saveRDS(p.ob, "../extdata/pvector_maSigPro.RDS")

x <- capture.output(tfit <- T.fit(p.ob, step.method = "backward", alfa = 0.05))

# Save the object for testing later
saveRDS(tfit, "../extdata/tfit_maSigPro.RDS")

# Get the significant genes
source("../../Testing_And_Development/old_maSigPro/get.siggenes_test.R")
sigs <- get.siggenes(tfit, rsq = 0.05, vars = "groups")

# Save object for testing later
saveRDS(sigs, "../extdata/sigs_maSigPro.RDS")
```

---

### Evaluation with R-prof

```{r}
load <- function() {
  suppressPackageStartupMessages(library(maSigPro))
  suppressPackageStartupMessages(library(MASS))
  suppressPackageStartupMessages(library(scran))
  suppressPackageStartupMessages(library(tidyverse))
  suppressPackageStartupMessages(library(scMaSigPro))
  suppressPackageStartupMessages(library(utils))
  suppressPackageStartupMessages(library(profmem))
  
}
load()

# Load object from the /data
sce.test <- readRDS("../data/sce.test.RDS")
  
# Create a simple design file
design.file <- as.data.frame(colData(sce.test))
design.file$Path1 <- ifelse(design.file$Group == "Path1", 1, 0)
design.file$Path2 <- ifelse(design.file$Group == "Path2", 1, 0)
design.file$Rep <- c(1:nrow(design.file))
design.file <- design.file[, c(5, 8, 6, 7), ]
  
# Extract the counts
gCounts <- as.matrix(sce.test@assays@data$counts)
all(colnames(gCounts) == rownames(design.file$edesign))
```

```{r}
require(microbenchmark)
time_result <- microbenchmark(
    
"scMaSigPro (PVector + Tfit)" = {
x <-  sc_pVector(scmp.obj, p.vector.sig = 0.4, model.type = "nb")
gc <- capture.output(x <-  sc_tFit(x, covar.sig = 0.05))
}
,
"maSigPro (PVector + Tfit)" ={
gc <- capture.output(y <- p.vector(
  data = as.matrix(gCounts), Q = 0.4,
  design = new.design.file,
  counts = T, family = negative.binomial(10)
))
gc <- capture.output(
    y <- T.fit(y, step.method = "backward", alfa = 0.05)
    )
},

times = 5)

autoplot(time_result)
```

```{r}
require(microbenchmark)
time_result <- microbenchmark(
    
"scMaSigPro_Tfit" = {
    scmp.obj <- pvector_scMASigPro(scmp.obj,
  dist.family = "nb",
  assay.name = "counts", Q = 0.4,
  nb.k = 10
)
    
scmp.obj <- scMaSigPro_t_fit(scmp.obj,
  dist.family = "nb",
  assay.name = "counts", Q = 0.4,
  nb.k = 10
)

}
,
"maSigPro_Tfit" ={
    x <- capture.output(p.ob <- p.vector(
  data = as.matrix(gCounts), Q = 0.4,
  design = new.design.file,
  counts = T, family = negative.binomial(10)
))
x <- capture.output(x <- capture.output(
    tfit <- T.fit(p.ob, step.method = "backward", alfa = 0.05)
    ))
}
,

times = 10)

# Calculate the elapsed time
sum(time_result$time)/1e9
autoplot(time_result)
```

